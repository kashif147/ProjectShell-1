server {
    listen 80;
    server_name _;

    # Global headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $http_authorization;

    # ---------------------------------------------------------
    # CORS HEADERS (APPLY TO ALL RESPONSES)
    # ---------------------------------------------------------
    add_header 'Access-Control-Allow-Origin' $cors_origin always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods'
        'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'
        'Authorization, Content-Type, X-Requested-With, X-MS-TOKEN-AAD-ID-TOKEN, X-MS-TOKEN-AAD-ACCESS-TOKEN'
        always;
    add_header 'Access-Control-Max-Age' 86400 always;

    # Preflight
    if ($request_method = OPTIONS) {
        return 204;
    }

    ###################################################################
    # USER SERVICE – AUTH (NO JWT)
    ###################################################################
    location ^~ /user-service/auth/ {
        rewrite ^/user-service/(.*)$ /$1 break;

        proxy_pass http://user-service:5001/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # USER SERVICE – API (WITH JWT)
    ###################################################################
    location ^~ /user-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/user-service/(.*)$ /$1 break;
        proxy_pass http://user-service:5001/;
        proxy_http_version 1.1;

        proxy_set_header x-jwt-verified $http_x_jwt_verified;
        proxy_set_header x-gateway-signature $http_x_gateway_signature;
        proxy_set_header x-gateway-timestamp $http_x_gateway_timestamp;
        proxy_set_header x-user-id $http_x_user_id;
        proxy_set_header x-tenant-id $http_x_tenant_id;
        proxy_set_header x-user-roles $http_x_user_roles;
        proxy_set_header x-user-permissions $http_x_user_permissions;
        proxy_set_header x-token-expires-at $http_x_token_expires_at;
        proxy_set_header x-auth-source $http_x_auth_source;

        proxy_set_header Connection "";

        proxy_cache api_cache;
        proxy_cache_methods GET HEAD;
        add_header X-Cache-Status $upstream_cache_status;
    }

    ###################################################################
    # PORTAL SERVICE
    ###################################################################
    location ^~ /portal-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/portal-service/(.*)$ /$1 break;
        proxy_pass http://portal-service:4001/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # SUBSCRIPTION SERVICE
    ###################################################################
    location ^~ /subscription-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/subscription-service/(.*)$ /$1 break;
        proxy_pass http://subscription-service:4003/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # PROFILE SERVICE
    ###################################################################
    location ^~ /profile-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/profile-service/(.*)$ /$1 break;
        proxy_pass http://profile-service:4002/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # ACCOUNTS SERVICE
    ###################################################################
    location ^~ /account-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/account-service/(.*)$ /$1 break;
        proxy_pass http://account-service:4000/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # COMMUNICATION SERVICE
    ###################################################################
    location ^~ /communication-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/communication-service/(.*)$ /$1 break;
        proxy_pass http://communication-service:4004/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # REPORTING SERVICE
    ###################################################################
    location ^~ /reporting-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/reporting-service/(.*)$ /$1 break;
        proxy_pass http://reporting-service:4005/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # Notification SERVICE
    ###################################################################
    location ^~ /notification-service/api/ {
        limit_req zone=api_rate burst=10 nodelay;
        access_by_lua_file /etc/nginx/lua/verify_jwt.lua;

        rewrite ^/notification-service/(.*)$ /$1 break;
        proxy_pass http://reporting-service:4010/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    ###################################################################
    # n8n Dashboards
    ###################################################################
    location /n8n/ {
        auth_basic "Restricted Area";
        auth_basic_user_file /etc/nginx/n8n.htpasswd;

        rewrite ^/n8n/?(.*)$ /$1 break;

        proxy_pass http://n8n:5678/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /n8n/static/ {
        rewrite ^/n8n/static/(.*)$ /static/$1 break;
        proxy_pass http://n8n:5678;
    }

    location /n8n/assets/ {
        rewrite ^/n8n/assets/(.*)$ /assets/$1 break;
        proxy_pass http://n8n:5678;
    }

    ###################################################################
    # RabbitMQ Dashboard
    ###################################################################
    location /rabbitmq/ {
        rewrite ^/rabbitmq/(.*)$ /$1 break;

        proxy_pass http://rabbitmq:15672/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    ###################################################################
    # HEALTH CHECK
    ###################################################################
    location /health {
        return 200 "Gateway is healthy\n";
    }

    ###################################################################
    # DEFAULT
    ###################################################################
    location / {
        return 200 "API Gateway running...\n";
    }
}
